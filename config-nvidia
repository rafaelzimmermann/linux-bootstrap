#!/bin/bash

# NVIDIA GeForce RTX 4080 SUPER (Ada Lovelace) configuration for Arch Linux
# - Installs nvidia-open (NVIDIA open kernel module, recommended for Ada Lovelace+)
# - Enables DRM modesetting and fbdev (required for Wayland/Hyprland)
# - Configures early module loading in initramfs
# - Removes kms hook to prevent nouveau from loading at early boot

set -e

source "$(dirname "$0")/lib/pkg.sh"

if [ "$OS" != "arch" ]; then
    echo "NVIDIA configuration is only supported on Arch Linux."
    exit 1
fi

# Enable multilib repo (required for lib32-nvidia-utils)
if ! grep -q '^\[multilib\]' /etc/pacman.conf; then
    sudo sed -i '/^#\[multilib\]/{s/^#//;n;s/^#//}' /etc/pacman.conf
    sudo pacman -Sy
fi

pkg_install nvidia-open nvidia-utils lib32-nvidia-utils nvidia-settings

# Enable DRM modesetting and fbdev for Wayland
echo "options nvidia_drm modeset=1 fbdev=1" | sudo tee /etc/modprobe.d/nvidia.conf

MKINITCPIO=/etc/mkinitcpio.conf

# Add nvidia modules for early loading
sudo sed -i 's/^MODULES=()/MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)/' "$MKINITCPIO"

# Remove kms hook to prevent nouveau from loading at early boot
sudo sed -i 's/ kms//' "$MKINITCPIO"

sudo mkinitcpio -P

echo "Done. Reboot to apply."
